<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="焦迪" />



<meta name="description" content="本文介绍STM32F767 DMA(Direct memory access controller)的基本用法。">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32F767 DMA的基本用法">
<meta property="og:url" content="http://jiaodi.tech/2018/05/19/stm32f767-uart-dma/index.html">
<meta property="og:site_name" content="焦迪的博客">
<meta property="og:description" content="本文介绍STM32F767 DMA(Direct memory access controller)的基本用法。">
<meta property="og:image" content="http://omcg8fk23.bkt.clouddn.com/stm32f757_dma01.png">
<meta property="og:image" content="http://omcg8fk23.bkt.clouddn.com/stm32f757_dma02.png">
<meta property="og:updated_time" content="2018-05-21T15:01:43.353Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="STM32F767 DMA的基本用法">
<meta name="twitter:description" content="本文介绍STM32F767 DMA(Direct memory access controller)的基本用法。">
<meta name="twitter:image" content="http://omcg8fk23.bkt.clouddn.com/stm32f757_dma01.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="焦迪的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="http://omcg8fk23.bkt.clouddn.com/Jay.jpg">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>STM32F767 DMA的基本用法 | 焦迪的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->






</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="http://omcg8fk23.bkt.clouddn.com/Jay.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">焦迪</a></h1>
        </hgroup>

        
        <p class="header-subtitle">Shape of my heart.</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:nemojiao@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/nemoj" title="GitHub"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/802-11/">802.11</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AD7616/">AD7616</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Allegro/">Allegro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Buck/">Buck</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C2000/">C2000</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCS/">CCS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cadence/">Cadence</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DCDC/">DCDC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DMA/">DMA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DSP/">DSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/F28379D/">F28379D</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FMC/">FMC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flash/">Flash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPIO/">GPIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDC1010/">HDC1010</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I2C/">I2C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IWDG/">IWDG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keil/">Keil</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MAC/">MAC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MLCC/">MLCC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MPU/">MPU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Noise/">Noise</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PCB/">PCB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHY/">PHY</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PWM/">PWM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pierce/">Pierce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PyInstaller/">PyInstaller</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/QUADSPI/">QUADSPI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RTC/">RTC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDRAM/">SDRAM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STM32CubeMX/">STM32CubeMX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STM32F7/">STM32F7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sensor/">Sensor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Systick/">Systick</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Timer/">Timer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UART/">UART</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WWDG/">WWDG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XDS100/">XDS100</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crystal/">crystal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interrupt/">interrupt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oscillator/">oscillator</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/serial/">serial</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/串口/">串口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前馈电容/">前馈电容</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动态响应/">动态响应</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/封装/">封装</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/差分线/">差分线</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/等长线/">等长线</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高速电路/">高速电路</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://zhangxb.tech/">张晓斌</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://gaomf.cn/">高明飞</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://tongzai.tech/">桐仔</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">雨下整夜，此刻初晴.</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">焦迪</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="http://omcg8fk23.bkt.clouddn.com/Jay.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">焦迪</a></h1>
            </hgroup>
            
            <p class="header-subtitle">Shape of my heart.</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:nemojiao@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/nemoj" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-stm32f767-uart-dma" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/05/19/stm32f767-uart-dma/" class="article-date">
      <time datetime="2018-05-19T12:19:51.000Z" itemprop="datePublished">2018-05-19</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      STM32F767 DMA的基本用法
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/嵌入式/">嵌入式</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DMA/">DMA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STM32F7/">STM32F7</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本文介绍STM32F767 DMA(Direct memory access controller)的基本用法。</p>
<a id="more"></a>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><h3 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h3><ul>
<li>电脑：Windows 10 Home x64</li>
<li>Apollo STM32F767开发板(ST-LINK V2仿真器)</li>
</ul>
<h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h3><ul>
<li>Keil Version 5.24.1 (Pack Installer：Keil.STM32F7xx_DFP.2.9.0.pack)</li>
<li>STM32CubeMX Version 4.25.0(Packages Manager：STM32CubeF7)</li>
</ul>
<h2 id="DMA的基本特性"><a href="#DMA的基本特性" class="headerlink" title="DMA的基本特性"></a>DMA的基本特性</h2><p>&emsp;直接存储器访问 (DMA) 用于在<code>外设与存储器</code>之间以及<code>存储器与存储器</code>之间提供高速数据传输。可以在无需任何 CPU 操作的情况下通过 DMA 快速移动数据。这样节省的 CPU 资源可供其它操作使用。</p>
<p>&emsp;两个 DMA 控制器总共有 <code>16</code> 个数据流（每个控制器 <code>8</code> 个），每一个 DMA 控制器都用于管理一个或多个外设的存储器访问请求。每个数据流总共可以有多达 <code>8 个通道</code>（或称请求）。每个通道都有一个仲裁器，用于处理 DMA 请求间的优先级。</p>
<h3 id="系统框图"><a href="#系统框图" class="headerlink" title="系统框图"></a>系统框图</h3><p>&emsp;DMA的系统框图如下所示。</p>
<p><img src="http://omcg8fk23.bkt.clouddn.com/stm32f757_dma01.png" alt=""></p>
<h3 id="主要特性"><a href="#主要特性" class="headerlink" title="主要特性"></a>主要特性</h3><p>&emsp;DMA的特性较为复杂，重点如下：</p>
<ul>
<li>STM32F767具有2个DMA控制器；</li>
<li>每个 DMA 控制器有 8 个数据流，每个数据流有多达 8 个通道(或称请求)；</li>
<li>每个数据流有4级32位先进先出FIFO；</li>
<li>通过硬件可以将每个数据流配置为：支持外设到存储器、存储器到外设和存储器到存储器传输的常规通道；在存储器端支持双缓冲的双缓冲区通道；</li>
<li>DMA 数据流请求之间的优先级可用软件编程（4 个级别：非常高、高、中、低）；</li>
<li>可供每个数据流选择的通道请求多达 8 个；</li>
<li>要传输的数据项的数目可以由 DMA 控制器或外设管理；</li>
<li>DMA 流控制器：要传输的数据项的数目可用软件编程，从 1 至 65535；</li>
<li>对源和目标的增量或非增量寻址；</li>
<li>5 个事件标志（DMA 半传输、DMA 传输完成、DMA 传输错误、DMA FIFO 错误、直接模式错误），进行逻辑或运算，从而产生每个数据流的单个中断请求。</li>
</ul>
<h3 id="DMA通道选择"><a href="#DMA通道选择" class="headerlink" title="DMA通道选择"></a>DMA通道选择</h3><p>&emsp;DMA中每一个数据流均有一个DMA请求。DMA请求映射的列表如下所示。</p>
<p><img src="http://omcg8fk23.bkt.clouddn.com/stm32f757_dma02.png" alt=""></p>
<h2 id="DMA的基本设置"><a href="#DMA的基本设置" class="headerlink" title="DMA的基本设置"></a>DMA的基本设置</h2><p>&emsp;DMA的具体应用方式很多，本文以<code>用DMA实现UART1数据发送</code>为例讲解DMA的用法。</p>
<h3 id="DMA通道选择-1"><a href="#DMA通道选择-1" class="headerlink" title="DMA通道选择"></a>DMA通道选择</h3><p>&emsp;<code>USART1_TX</code>请求位于<code>DMA2的数据流7</code>，<code>通道4</code>。</p>
<h3 id="DMA时钟与NVIC初始化"><a href="#DMA时钟与NVIC初始化" class="headerlink" title="DMA时钟与NVIC初始化"></a>DMA时钟与NVIC初始化</h3><p>&emsp;初始化代码如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line">  * Enable DMA controller clock</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_DMA_Init</span><span class="params">(<span class="keyword">void</span>)</span> </span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* DMA controller clock enable */</span></div><div class="line">  __HAL_RCC_DMA2_CLK_ENABLE();</div><div class="line"></div><div class="line">  <span class="comment">/* DMA interrupt init */</span></div><div class="line">  <span class="comment">/* DMA2_Stream7_IRQn interrupt configuration */</span></div><div class="line">  HAL_NVIC_SetPriority(DMA2_Stream7_IRQn, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">  HAL_NVIC_EnableIRQ(DMA2_Stream7_IRQn);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;代码的主要功能为：</p>
<ul>
<li>使能DMA2时钟；</li>
<li>设定DMA2数据流7的NVIC优先级并使能；DMA中断优先级需要根据系统整体进行确定，本处设置只是示例。</li>
</ul>
<h3 id="UART初始化"><a href="#UART初始化" class="headerlink" title="UART初始化"></a>UART初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* USART1 init function */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_USART1_UART_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">  huart1.Instance = USART1;</div><div class="line">  huart1.Init.BaudRate = <span class="number">115200</span>;</div><div class="line">  huart1.Init.WordLength = UART_WORDLENGTH_8B;</div><div class="line">  huart1.Init.StopBits = UART_STOPBITS_1;</div><div class="line">  huart1.Init.Parity = UART_PARITY_NONE;</div><div class="line">  huart1.Init.Mode = UART_MODE_TX_RX;</div><div class="line">  huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;</div><div class="line">  huart1.Init.OverSampling = UART_OVERSAMPLING_16;</div><div class="line">  huart1.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;</div><div class="line">  huart1.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;</div><div class="line">  <span class="keyword">if</span> (HAL_UART_Init(&amp;huart1) != HAL_OK)</div><div class="line">  &#123;</div><div class="line">    _Error_Handler(__FILE__, __LINE__);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_UART_MspInit</span><span class="params">(UART_HandleTypeDef* uartHandle)</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">  GPIO_InitTypeDef GPIO_InitStruct;</div><div class="line">  <span class="keyword">if</span>(uartHandle-&gt;Instance==USART1)</div><div class="line">  &#123;</div><div class="line">  <span class="comment">/* USER CODE BEGIN USART1_MspInit 0 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END USART1_MspInit 0 */</span></div><div class="line">    <span class="comment">/* USART1 clock enable */</span></div><div class="line">    __HAL_RCC_USART1_CLK_ENABLE();</div><div class="line">  </div><div class="line">    <span class="comment">/**USART1 GPIO Configuration    </span></div><div class="line">    PA9     ------&gt; USART1_TX</div><div class="line">    PA10     ------&gt; USART1_RX </div><div class="line">    */</div><div class="line">    GPIO_InitStruct.Pin = GPIO_PIN_9|GPIO_PIN_10;</div><div class="line">    GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;</div><div class="line">    GPIO_InitStruct.Pull = GPIO_NOPULL;</div><div class="line">    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;</div><div class="line">    GPIO_InitStruct.Alternate = GPIO_AF7_USART1;</div><div class="line">    HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div><div class="line">	  </div><div class="line">	<span class="comment">/* USART1 DMA Init */</span></div><div class="line">    <span class="comment">/* USART1_TX Init */</span></div><div class="line">    hdma_usart1_tx.Instance = DMA2_Stream7;</div><div class="line">    hdma_usart1_tx.Init.Channel = DMA_CHANNEL_4;</div><div class="line">    hdma_usart1_tx.Init.Direction = DMA_MEMORY_TO_PERIPH;</div><div class="line">    hdma_usart1_tx.Init.PeriphInc = DMA_PINC_DISABLE;</div><div class="line">    hdma_usart1_tx.Init.MemInc = DMA_MINC_ENABLE;</div><div class="line">    hdma_usart1_tx.Init.PeriphDataAlignment = DMA_PDATAALIGN_BYTE;</div><div class="line">    hdma_usart1_tx.Init.MemDataAlignment = DMA_MDATAALIGN_BYTE;</div><div class="line">    hdma_usart1_tx.Init.Mode = DMA_NORMAL;</div><div class="line">    hdma_usart1_tx.Init.Priority = DMA_PRIORITY_LOW;</div><div class="line">    hdma_usart1_tx.Init.FIFOMode = DMA_FIFOMODE_DISABLE;</div><div class="line">    <span class="keyword">if</span> (HAL_DMA_Init(&amp;hdma_usart1_tx) != HAL_OK)</div><div class="line">    &#123;</div><div class="line">      _Error_Handler(__FILE__, __LINE__);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    __HAL_LINKDMA(uartHandle,hdmatx,hdma_usart1_tx);</div><div class="line">	</div><div class="line">	<span class="comment">/* USART1 interrupt Init */</span></div><div class="line">    HAL_NVIC_SetPriority(USART1_IRQn, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    HAL_NVIC_EnableIRQ(USART1_IRQn);</div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE BEGIN USART1_MspInit 1 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END USART1_MspInit 1 */</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;UART的初始化串口部分之前已经介绍过，这里不再复述，DMA相关部分功能如下：</p>
<ul>
<li>初始化实例选择为DMA2数据流7，通道4；</li>
<li>方向为：存储器到外设；</li>
<li>DMA外设：非增量模式；</li>
<li>存储器外设：增量模式；</li>
<li>外设数据对齐：byte，即为8bit；</li>
<li>存储器数据对齐：byte，即为8bit；</li>
<li>DMA模式：normal；</li>
<li>DMA优先级：低；</li>
<li>DMA FIFO模式：禁用；</li>
<li>通过<code>HAL_DMA_Init()</code>函数初始化DMA；</li>
<li>通过<code>__HAL_LINKDMA()</code>函数建立<code>huart1</code>与<code>hdma_usart1_tx</code>关联；</li>
<li>设置USART1 NVIC优先级并使能中断。</li>
</ul>
<h3 id="HAL-DMA-Init-实现"><a href="#HAL-DMA-Init-实现" class="headerlink" title="HAL_DMA_Init()实现"></a>HAL_DMA_Init()实现</h3><p>&emsp;以上设置通过<code>HAL_DMA_Init()</code>函数实现，该函数具体如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Initialize the DMA according to the specified</div><div class="line">  *         parameters in the DMA_InitTypeDef and create the associated handle.</div><div class="line">  * @param  hdma Pointer to a DMA_HandleTypeDef structure that contains</div><div class="line">  *               the configuration information for the specified DMA Stream.  </div><div class="line">  * @retval HAL status</div><div class="line">  */</div><div class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_DMA_Init</span><span class="params">(DMA_HandleTypeDef *hdma)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint32_t</span> tmp = <span class="number">0U</span>;</div><div class="line">  <span class="keyword">uint32_t</span> tickstart = HAL_GetTick();</div><div class="line">  DMA_Base_Registers *regs;</div><div class="line"></div><div class="line">  <span class="comment">/* Check the DMA peripheral state */</span></div><div class="line">  <span class="keyword">if</span>(hdma == <span class="literal">NULL</span>)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">return</span> HAL_ERROR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* Check the parameters */</span></div><div class="line">  assert_param(IS_DMA_STREAM_ALL_INSTANCE(hdma-&gt;Instance));</div><div class="line">  assert_param(IS_DMA_CHANNEL(hdma-&gt;Init.Channel));</div><div class="line">  assert_param(IS_DMA_DIRECTION(hdma-&gt;Init.Direction));</div><div class="line">  assert_param(IS_DMA_PERIPHERAL_INC_STATE(hdma-&gt;Init.PeriphInc));</div><div class="line">  assert_param(IS_DMA_MEMORY_INC_STATE(hdma-&gt;Init.MemInc));</div><div class="line">  assert_param(IS_DMA_PERIPHERAL_DATA_SIZE(hdma-&gt;Init.PeriphDataAlignment));</div><div class="line">  assert_param(IS_DMA_MEMORY_DATA_SIZE(hdma-&gt;Init.MemDataAlignment));</div><div class="line">  assert_param(IS_DMA_MODE(hdma-&gt;Init.Mode));</div><div class="line">  assert_param(IS_DMA_PRIORITY(hdma-&gt;Init.Priority));</div><div class="line">  assert_param(IS_DMA_FIFO_MODE_STATE(hdma-&gt;Init.FIFOMode));</div><div class="line">  <span class="comment">/* Check the memory burst, peripheral burst and FIFO threshold parameters only</span></div><div class="line">     when FIFO mode is enabled */</div><div class="line">  <span class="keyword">if</span>(hdma-&gt;Init.FIFOMode != DMA_FIFOMODE_DISABLE)</div><div class="line">  &#123;</div><div class="line">    assert_param(IS_DMA_FIFO_THRESHOLD(hdma-&gt;Init.FIFOThreshold));</div><div class="line">    assert_param(IS_DMA_MEMORY_BURST(hdma-&gt;Init.MemBurst));</div><div class="line">    assert_param(IS_DMA_PERIPHERAL_BURST(hdma-&gt;Init.PeriphBurst));</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/* Allocate lock resource */</span></div><div class="line">  __HAL_UNLOCK(hdma);</div><div class="line"></div><div class="line">  <span class="comment">/* Change DMA peripheral state */</span></div><div class="line">  hdma-&gt;State = HAL_DMA_STATE_BUSY;</div><div class="line">  </div><div class="line">  <span class="comment">/* Disable the peripheral */</span></div><div class="line">  __HAL_DMA_DISABLE(hdma);</div><div class="line">  </div><div class="line">  <span class="comment">/* Check if the DMA Stream is effectively disabled */</span></div><div class="line">  <span class="keyword">while</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_EN) != RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Check for the Timeout */</span></div><div class="line">    <span class="keyword">if</span>((HAL_GetTick() - tickstart ) &gt; HAL_TIMEOUT_DMA_ABORT)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Update error code */</span></div><div class="line">      hdma-&gt;ErrorCode = HAL_DMA_ERROR_TIMEOUT;</div><div class="line">      </div><div class="line">      <span class="comment">/* Change the DMA state */</span></div><div class="line">      hdma-&gt;State = HAL_DMA_STATE_TIMEOUT;</div><div class="line">      </div><div class="line">      <span class="keyword">return</span> HAL_TIMEOUT;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/* Get the CR register value */</span></div><div class="line">  tmp = hdma-&gt;Instance-&gt;CR;</div><div class="line"></div><div class="line">  <span class="comment">/* Clear CHSEL, MBURST, PBURST, PL, MSIZE, PSIZE, MINC, PINC, CIRC, DIR, CT and DBM bits */</span></div><div class="line">  tmp &amp;= ((<span class="keyword">uint32_t</span>)~(DMA_SxCR_CHSEL | DMA_SxCR_MBURST | DMA_SxCR_PBURST | \</div><div class="line">                      DMA_SxCR_PL    | DMA_SxCR_MSIZE  | DMA_SxCR_PSIZE  | \</div><div class="line">                      DMA_SxCR_MINC  | DMA_SxCR_PINC   | DMA_SxCR_CIRC   | \</div><div class="line">                      DMA_SxCR_DIR   | DMA_SxCR_CT     | DMA_SxCR_DBM));</div><div class="line"></div><div class="line">  <span class="comment">/* Prepare the DMA Stream configuration */</span></div><div class="line">  tmp |=  hdma-&gt;Init.Channel             | hdma-&gt;Init.Direction        |</div><div class="line">          hdma-&gt;Init.PeriphInc           | hdma-&gt;Init.MemInc           |</div><div class="line">          hdma-&gt;Init.PeriphDataAlignment | hdma-&gt;Init.MemDataAlignment |</div><div class="line">          hdma-&gt;Init.Mode                | hdma-&gt;Init.Priority;</div><div class="line"></div><div class="line">  <span class="comment">/* the Memory burst and peripheral burst are not used when the FIFO is disabled */</span></div><div class="line">  <span class="keyword">if</span>(hdma-&gt;Init.FIFOMode == DMA_FIFOMODE_ENABLE)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Get memory burst and peripheral burst */</span></div><div class="line">    tmp |=  hdma-&gt;Init.MemBurst | hdma-&gt;Init.PeriphBurst;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/* Write to DMA Stream CR register */</span></div><div class="line">  hdma-&gt;Instance-&gt;CR = tmp;  </div><div class="line"></div><div class="line">  <span class="comment">/* Get the FCR register value */</span></div><div class="line">  tmp = hdma-&gt;Instance-&gt;FCR;</div><div class="line"></div><div class="line">  <span class="comment">/* Clear Direct mode and FIFO threshold bits */</span></div><div class="line">  tmp &amp;= (<span class="keyword">uint32_t</span>)~(DMA_SxFCR_DMDIS | DMA_SxFCR_FTH);</div><div class="line"></div><div class="line">  <span class="comment">/* Prepare the DMA Stream FIFO configuration */</span></div><div class="line">  tmp |= hdma-&gt;Init.FIFOMode;</div><div class="line"></div><div class="line">  <span class="comment">/* The FIFO threshold is not used when the FIFO mode is disabled */</span></div><div class="line">  <span class="keyword">if</span>(hdma-&gt;Init.FIFOMode == DMA_FIFOMODE_ENABLE)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Get the FIFO threshold */</span></div><div class="line">    tmp |= hdma-&gt;Init.FIFOThreshold;</div><div class="line">    </div><div class="line">    <span class="comment">/* Check compatibility between FIFO threshold level and size of the memory burst */</span></div><div class="line">    <span class="comment">/* for INCR4, INCR8, INCR16 bursts */</span></div><div class="line">    <span class="keyword">if</span> (hdma-&gt;Init.MemBurst != DMA_MBURST_SINGLE)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">if</span> (DMA_CheckFifoParam(hdma) != HAL_OK)</div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Update error code */</span></div><div class="line">        hdma-&gt;ErrorCode = HAL_DMA_ERROR_PARAM;</div><div class="line">        </div><div class="line">        <span class="comment">/* Change the DMA state */</span></div><div class="line">        hdma-&gt;State = HAL_DMA_STATE_READY;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> HAL_ERROR; </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/* Write to DMA Stream FCR */</span></div><div class="line">  hdma-&gt;Instance-&gt;FCR = tmp;</div><div class="line"></div><div class="line">  <span class="comment">/* Initialize StreamBaseAddress and StreamIndex parameters to be used to calculate</span></div><div class="line">     DMA steam Base Address needed by HAL_DMA_IRQHandler() and HAL_DMA_PollForTransfer() */</div><div class="line">  regs = (DMA_Base_Registers *)DMA_CalcBaseAndBitshift(hdma);</div><div class="line">  </div><div class="line">  <span class="comment">/* Clear all interrupt flags */</span></div><div class="line">  regs-&gt;IFCR = <span class="number">0x3F</span>U &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line"></div><div class="line">  <span class="comment">/* Initialize the error code */</span></div><div class="line">  hdma-&gt;ErrorCode = HAL_DMA_ERROR_NONE;</div><div class="line">                                                                                     </div><div class="line">  <span class="comment">/* Initialize the DMA state */</span></div><div class="line">  hdma-&gt;State = HAL_DMA_STATE_READY;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> HAL_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;该函数的主要功能有：</p>
<ul>
<li>通过DMA配置寄存器<code>DMA_SxCR</code> <code>EN</code>位复位禁止数据流，并等待确认数据流已关闭；</li>
<li>tmp首先读取<code>DMA_SxCR</code>寄存器的值，同时复位所有需要配置的控制位；</li>
<li>tmp中写入CHSEL、DIR、PINC、MINC、PSIZE、MINC、CIRC、PFCTRL、PL等配置位；</li>
<li>将tmp值写入到<code>DMA_SxCR</code>寄存器；</li>
<li>tmp读取FIFO控制寄存器<code>DMA_SxFCR</code>的值，复位直接模式禁止位DMDIS与FIFO阈值选择位FTH；</li>
<li>tmp写入FIFO模式位，本例中使用直接模式，禁用FIFO；</li>
<li>将tmp值写入到<code>DMA_SxFCR</code>寄存器；</li>
<li>通过<code>DMA_HIFCR</code>/<code>DMA_LIFCR</code>寄存器清除DMA所有中断标志位；</li>
<li>至此，完成DMA初始化。</li>
</ul>
<blockquote>
<p>源代码中通过0x3F清除中断标志位可能存在问题，DMA_HIFCR/DMA_LIFCR寄存器中断清除标志位仅有5个，此处我认为写入0x3D才是合理值。</p>
<p>ST官方回复：这个预留位，软件上写0/写1对它没有影响，这个预留动作时靠硬件保证的。</p>
</blockquote>
<h3 id="HAL-LINKDMA-实现"><a href="#HAL-LINKDMA-实现" class="headerlink" title="__HAL_LINKDMA()实现"></a>__HAL_LINKDMA()实现</h3><p>&emsp;该函数具体如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">__HAL_LINKDMA(uartHandle,hdmatx,hdma_usart1_tx);</div><div class="line"></div><div class="line">#define __HAL_LINKDMA(__HANDLE__, __PPP_DMA_FIELD__, __DMA_HANDLE__)               \</div><div class="line">                        do&#123;                                                      \</div><div class="line">                              (__HANDLE__)-&gt;__PPP_DMA_FIELD__ = &amp;(__DMA_HANDLE__); \</div><div class="line">                              (__DMA_HANDLE__).Parent = (__HANDLE__);             \</div><div class="line">                          &#125; while(0)</div></pre></td></tr></table></figure>
<p>&emsp;该函数的功能如下：</p>
<ul>
<li><code>__HAL_LINKDMA()</code>传入的参数为<code>huart1</code>，<code>hdmatx</code>代表<code>huart1</code>结构体<code>UART_HandleTypeDef</code>定义中的具体成员变量，即将<code>hdma_usart1_tx</code>作为<code>huart1</code>的<code>hdmatx</code>成员变量；同时<code>huart1</code>作为<code>hdma_usart1_tx</code>的<code>Parent</code>成员变量。</li>
</ul>
<h2 id="基于DMA的UART发送实现"><a href="#基于DMA的UART发送实现" class="headerlink" title="基于DMA的UART发送实现"></a>基于DMA的UART发送实现</h2><h3 id="HAL-UART-Transmit-DMA-实现"><a href="#HAL-UART-Transmit-DMA-实现" class="headerlink" title="HAL_UART_Transmit_DMA()实现"></a>HAL_UART_Transmit_DMA()实现</h3><p>&emsp;DMA设置完成后，即可基于DMA进行UART发送，具体通过<code>HAL_UART_Transmit_DMA()</code>函数实现，使用方法如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">uint8 sendStr[<span class="number">65535</span>] = <span class="string">"1234567890"</span>;</div><div class="line">HAL_UART_Transmit_DMA(&amp;huart1,sendStr,<span class="keyword">sizeof</span>(sendStr));</div></pre></td></tr></table></figure>
<p>&emsp;<code>HAL_UART_Transmit_DMA()</code>函数的定义如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief Send an amount of data in DMA mode.</div><div class="line">  * @param huart UART handle.</div><div class="line">  * @param pData pointer to data buffer.</div><div class="line">  * @param Size amount of data to be sent.</div><div class="line">  * @retval HAL status</div><div class="line">  */</div><div class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_UART_Transmit_DMA</span><span class="params">(UART_HandleTypeDef *huart, <span class="keyword">uint8_t</span> *pData, <span class="keyword">uint16_t</span> Size)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint32_t</span> *tmp;</div><div class="line"></div><div class="line">  <span class="comment">/* Check that a Tx process is not already ongoing */</span></div><div class="line">  <span class="keyword">if</span>(huart-&gt;gState == HAL_UART_STATE_READY)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>((pData == <span class="literal">NULL</span> ) || (Size == <span class="number">0U</span>))</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">return</span> HAL_ERROR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* Process Locked */</span></div><div class="line">    __HAL_LOCK(huart);</div><div class="line"></div><div class="line">    huart-&gt;pTxBuffPtr = pData;</div><div class="line">    huart-&gt;TxXferSize = Size;</div><div class="line">    huart-&gt;TxXferCount = Size;</div><div class="line"></div><div class="line">    huart-&gt;ErrorCode = HAL_UART_ERROR_NONE;</div><div class="line">    huart-&gt;gState = HAL_UART_STATE_BUSY_TX;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the UART DMA transfer complete callback */</span></div><div class="line">    huart-&gt;hdmatx-&gt;XferCpltCallback = UART_DMATransmitCplt;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the UART DMA Half transfer complete callback */</span></div><div class="line">    huart-&gt;hdmatx-&gt;XferHalfCpltCallback = UART_DMATxHalfCplt;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the DMA error callback */</span></div><div class="line">    huart-&gt;hdmatx-&gt;XferErrorCallback = UART_DMAError;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the DMA abort callback */</span></div><div class="line">    huart-&gt;hdmatx-&gt;XferAbortCallback = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Enable the UART transmit DMA channel */</span></div><div class="line">    tmp = (<span class="keyword">uint32_t</span>*)&amp;pData;</div><div class="line">    HAL_DMA_Start_IT(huart-&gt;hdmatx, *(<span class="keyword">uint32_t</span>*)tmp, (<span class="keyword">uint32_t</span>)&amp;huart-&gt;Instance-&gt;TDR, Size);</div><div class="line"></div><div class="line">    <span class="comment">/* Clear the TC flag in the SR register by writing 0 to it */</span></div><div class="line">    __HAL_UART_CLEAR_IT(huart, UART_FLAG_TC);</div><div class="line"></div><div class="line">    <span class="comment">/* Process Unlocked */</span></div><div class="line">    __HAL_UNLOCK(huart);</div><div class="line"></div><div class="line">    <span class="comment">/* Enable the DMA transfer for transmit request by setting the DMAT bit</span></div><div class="line">       in the UART CR3 register */</div><div class="line">    SET_BIT(huart-&gt;Instance-&gt;CR3, USART_CR3_DMAT);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> HAL_OK;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">return</span> HAL_BUSY;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;该函数实现的功能为：</p>
<ul>
<li><code>huart1</code>的成员变量<code>pTxBuffPtr</code>为发送数据buffer指针，将其指向待发送数据；</li>
<li><code>huart1</code>的成员变量<code>TxXferSize</code>代表发送数据数目，成员变量<code>TxXferCount</code>代表发送数据计数器，初始值都将其设置为待发送数据个数；</li>
<li><code>huart1</code>的成员变量<code>hdmatx</code>也为一个结构体，其成员变量为DMA相关中断的函数指针：<code>XferCpltCallback</code>为DMA传输完成回调函数，<code>XferHalfCpltCallback</code>为DMA半传输完成回调函数，<code>XferErrorCallback</code>为DMA故障回调函数，<code>XferAbortCallback</code>为DMA中止回调函数；</li>
<li>通过<code>HAL_DMA_Start_IT()</code>使能DMA发送通道；</li>
<li>清除UART发送完成中断标志位TC；</li>
<li>置位<code>USARTx_CR3</code>寄存器DMAT位，使能DMA发送模式。</li>
</ul>
<p>&emsp;执行该函数后，UART将基于DMA模式进行发送。</p>
<h3 id="HAL-DMA-Start-IT-实现"><a href="#HAL-DMA-Start-IT-实现" class="headerlink" title="HAL_DMA_Start_IT()实现"></a>HAL_DMA_Start_IT()实现</h3><p>&emsp;<code>HAL_UART_Transmit_DMA()</code>中调用的核心函数<code>HAL_DMA_Start_IT()</code>实现如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Start the DMA Transfer with interrupt enabled.</div><div class="line">  * @param  hdma       pointer to a DMA_HandleTypeDef structure that contains</div><div class="line">  *                     the configuration information for the specified DMA Stream.  </div><div class="line">  * @param  SrcAddress The source memory Buffer address</div><div class="line">  * @param  DstAddress The destination memory Buffer address</div><div class="line">  * @param  DataLength The length of data to be transferred from source to destination</div><div class="line">  * @retval HAL status</div><div class="line">  */</div><div class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_DMA_Start_IT</span><span class="params">(DMA_HandleTypeDef *hdma, <span class="keyword">uint32_t</span> SrcAddress, <span class="keyword">uint32_t</span> DstAddress, <span class="keyword">uint32_t</span> DataLength)</span></span></div><div class="line">&#123;</div><div class="line">  HAL_StatusTypeDef status = HAL_OK;</div><div class="line"></div><div class="line">  <span class="comment">/* calculate DMA base and stream number */</span></div><div class="line">  DMA_Base_Registers *regs = (DMA_Base_Registers *)hdma-&gt;StreamBaseAddress;</div><div class="line">  </div><div class="line">  <span class="comment">/* Check the parameters */</span></div><div class="line">  assert_param(IS_DMA_BUFFER_SIZE(DataLength));</div><div class="line"> </div><div class="line">  <span class="comment">/* Process locked */</span></div><div class="line">  __HAL_LOCK(hdma);</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(HAL_DMA_STATE_READY == hdma-&gt;State)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Change DMA peripheral state */</span></div><div class="line">    hdma-&gt;State = HAL_DMA_STATE_BUSY;</div><div class="line">    </div><div class="line">    <span class="comment">/* Initialize the error code */</span></div><div class="line">    hdma-&gt;ErrorCode = HAL_DMA_ERROR_NONE;</div><div class="line">    </div><div class="line">    <span class="comment">/* Configure the source, destination address and the data length */</span></div><div class="line">    DMA_SetConfig(hdma, SrcAddress, DstAddress, DataLength);</div><div class="line">    </div><div class="line">    <span class="comment">/* Clear all interrupt flags at correct offset within the register */</span></div><div class="line">    regs-&gt;IFCR = <span class="number">0x3F</span>U &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line">    </div><div class="line">    <span class="comment">/* Enable Common interrupts*/</span></div><div class="line">    hdma-&gt;Instance-&gt;CR  |= DMA_IT_TC | DMA_IT_TE | DMA_IT_DME;</div><div class="line">    hdma-&gt;Instance-&gt;FCR |= DMA_IT_FE;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(hdma-&gt;XferHalfCpltCallback != <span class="literal">NULL</span>)</div><div class="line">    &#123;</div><div class="line">      hdma-&gt;Instance-&gt;CR  |= DMA_IT_HT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/* Enable the Peripheral */</span></div><div class="line">    __HAL_DMA_ENABLE(hdma);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Process unlocked */</span></div><div class="line">    __HAL_UNLOCK(hdma);	  </div><div class="line">    </div><div class="line">    <span class="comment">/* Return error status */</span></div><div class="line">    status = HAL_BUSY;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> status;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Sets the DMA Transfer parameter.</div><div class="line">  * @param  hdma       pointer to a DMA_HandleTypeDef structure that contains</div><div class="line">  *                     the configuration information for the specified DMA Stream.</div><div class="line">  * @param  SrcAddress The source memory Buffer address</div><div class="line">  * @param  DstAddress The destination memory Buffer address</div><div class="line">  * @param  DataLength The length of data to be transferred from source to destination</div><div class="line">  * @retval HAL status</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DMA_SetConfig</span><span class="params">(DMA_HandleTypeDef *hdma, <span class="keyword">uint32_t</span> SrcAddress, <span class="keyword">uint32_t</span> DstAddress, <span class="keyword">uint32_t</span> DataLength)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* Clear DBM bit */</span></div><div class="line">  hdma-&gt;Instance-&gt;CR &amp;= (<span class="keyword">uint32_t</span>)(~DMA_SxCR_DBM);</div><div class="line"></div><div class="line">  <span class="comment">/* Configure DMA Stream data length */</span></div><div class="line">  hdma-&gt;Instance-&gt;NDTR = DataLength;</div><div class="line"></div><div class="line">  <span class="comment">/* Memory to Peripheral */</span></div><div class="line">  <span class="keyword">if</span>((hdma-&gt;Init.Direction) == DMA_MEMORY_TO_PERIPH)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Configure DMA Stream destination address */</span></div><div class="line">    hdma-&gt;Instance-&gt;PAR = DstAddress;</div><div class="line"></div><div class="line">    <span class="comment">/* Configure DMA Stream source address */</span></div><div class="line">    hdma-&gt;Instance-&gt;M0AR = SrcAddress;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* Peripheral to Memory */</span></div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* Configure DMA Stream source address */</span></div><div class="line">    hdma-&gt;Instance-&gt;PAR = SrcAddress;</div><div class="line"></div><div class="line">    <span class="comment">/* Configure DMA Stream destination address */</span></div><div class="line">    hdma-&gt;Instance-&gt;M0AR = DstAddress;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Enable the specified DMA Stream.</div><div class="line">  * @param  __HANDLE__ DMA handle</div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAL_DMA_ENABLE(__HANDLE__)      ((__HANDLE__)-&gt;Instance-&gt;CR |=  DMA_SxCR_EN)</span></div></pre></td></tr></table></figure>
<p>&emsp;该函数实现的功能为：</p>
<ul>
<li>检查DMA发送数据长度是否合理，在1~65535范围内均可；</li>
<li>通过<code>DMA_SetConfig()</code>函数设置DMA发送的<code>DMA数据流</code>、<code>数据项数目</code>，设置<code>外设地址</code>为目标地址，设置<code>存储器地址</code>为源地址；</li>
<li>清空DMA数据流相关中断标志位；</li>
<li>置位DMA配置寄存器<code>DMA_SxCR</code> TCIE、TEIE、DMEIE位，分别使能传输完成中断、传输错误中断与直接模式错误中断；</li>
<li>置位DMA FIFO控制寄存器FEIE位，使能FIFO错误中断；本例中未使能FIFO；</li>
<li><code>XferHalfCpltCallback</code>为DMA半传输完成回调函数，其不为NULL时使能DMA半传输完成中断；</li>
<li>置位<code>DMA_SxCR</code>寄存器EN位，使能DMA数据流，随即开始DMA传输。</li>
</ul>
<h3 id="DMA中断服务函数"><a href="#DMA中断服务函数" class="headerlink" title="DMA中断服务函数"></a>DMA中断服务函数</h3><p>&emsp;DMA中断服务函数如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* @brief This function handles DMA2 stream7 global interrupt.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DMA2_Stream7_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* USER CODE BEGIN DMA2_Stream7_IRQn 0 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END DMA2_Stream7_IRQn 0 */</span></div><div class="line">  HAL_DMA_IRQHandler(&amp;hdma_usart1_tx);</div><div class="line">  <span class="comment">/* USER CODE BEGIN DMA2_Stream7_IRQn 1 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END DMA2_Stream7_IRQn 1 */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Handles DMA interrupt request.</div><div class="line">  * @param  hdma pointer to a DMA_HandleTypeDef structure that contains</div><div class="line">  *               the configuration information for the specified DMA Stream.  </div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_DMA_IRQHandler</span><span class="params">(DMA_HandleTypeDef *hdma)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint32_t</span> tmpisr;</div><div class="line">  __IO <span class="keyword">uint32_t</span> count = <span class="number">0</span>;</div><div class="line">  <span class="keyword">uint32_t</span> timeout = SystemCoreClock / <span class="number">9600</span>;</div><div class="line"></div><div class="line">  <span class="comment">/* calculate DMA base and stream number */</span></div><div class="line">  DMA_Base_Registers *regs = (DMA_Base_Registers *)hdma-&gt;StreamBaseAddress;</div><div class="line"></div><div class="line">  tmpisr = regs-&gt;ISR;</div><div class="line"></div><div class="line">  <span class="comment">/* Transfer Error Interrupt management ***************************************/</span></div><div class="line">  <span class="keyword">if</span> ((tmpisr &amp; (DMA_FLAG_TEIF0_4 &lt;&lt; hdma-&gt;StreamIndex)) != RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>(__HAL_DMA_GET_IT_SOURCE(hdma, DMA_IT_TE) != RESET)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Disable the transfer error interrupt */</span></div><div class="line">      hdma-&gt;Instance-&gt;CR  &amp;= ~(DMA_IT_TE);</div><div class="line">      </div><div class="line">      <span class="comment">/* Clear the transfer error flag */</span></div><div class="line">      regs-&gt;IFCR = DMA_FLAG_TEIF0_4 &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line">      </div><div class="line">      <span class="comment">/* Update error code */</span></div><div class="line">      hdma-&gt;ErrorCode |= HAL_DMA_ERROR_TE;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* FIFO Error Interrupt management ******************************************/</span></div><div class="line">  <span class="keyword">if</span> ((tmpisr &amp; (DMA_FLAG_FEIF0_4 &lt;&lt; hdma-&gt;StreamIndex)) != RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>(__HAL_DMA_GET_IT_SOURCE(hdma, DMA_IT_FE) != RESET)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Clear the FIFO error flag */</span></div><div class="line">      regs-&gt;IFCR = DMA_FLAG_FEIF0_4 &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line"></div><div class="line">      <span class="comment">/* Update error code */</span></div><div class="line">      hdma-&gt;ErrorCode |= HAL_DMA_ERROR_FE;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* Direct Mode Error Interrupt management ***********************************/</span></div><div class="line">  <span class="keyword">if</span> ((tmpisr &amp; (DMA_FLAG_DMEIF0_4 &lt;&lt; hdma-&gt;StreamIndex)) != RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>(__HAL_DMA_GET_IT_SOURCE(hdma, DMA_IT_DME) != RESET)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Clear the direct mode error flag */</span></div><div class="line">      regs-&gt;IFCR = DMA_FLAG_DMEIF0_4 &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line"></div><div class="line">      <span class="comment">/* Update error code */</span></div><div class="line">      hdma-&gt;ErrorCode |= HAL_DMA_ERROR_DME;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* Half Transfer Complete Interrupt management ******************************/</span></div><div class="line">  <span class="keyword">if</span> ((tmpisr &amp; (DMA_FLAG_HTIF0_4 &lt;&lt; hdma-&gt;StreamIndex)) != RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>(__HAL_DMA_GET_IT_SOURCE(hdma, DMA_IT_HT) != RESET)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Clear the half transfer complete flag */</span></div><div class="line">      regs-&gt;IFCR = DMA_FLAG_HTIF0_4 &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line">      </div><div class="line">      <span class="comment">/* Multi_Buffering mode enabled */</span></div><div class="line">      <span class="keyword">if</span>(((hdma-&gt;Instance-&gt;CR) &amp; (<span class="keyword">uint32_t</span>)(DMA_SxCR_DBM)) != RESET)</div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Current memory buffer used is Memory 0 */</span></div><div class="line">        <span class="keyword">if</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_CT) == RESET)</div><div class="line">        &#123;</div><div class="line">          <span class="keyword">if</span>(hdma-&gt;XferHalfCpltCallback != <span class="literal">NULL</span>)</div><div class="line">          &#123;</div><div class="line">            <span class="comment">/* Half transfer callback */</span></div><div class="line">            hdma-&gt;XferHalfCpltCallback(hdma);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/* Current memory buffer used is Memory 1 */</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">          <span class="keyword">if</span>(hdma-&gt;XferM1HalfCpltCallback != <span class="literal">NULL</span>)</div><div class="line">          &#123;</div><div class="line">            <span class="comment">/* Half transfer callback */</span></div><div class="line">            hdma-&gt;XferM1HalfCpltCallback(hdma);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Disable the half transfer interrupt if the DMA mode is not CIRCULAR */</span></div><div class="line">        <span class="keyword">if</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_CIRC) == RESET)</div><div class="line">        &#123;</div><div class="line">          <span class="comment">/* Disable the half transfer interrupt */</span></div><div class="line">          hdma-&gt;Instance-&gt;CR  &amp;= ~(DMA_IT_HT);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(hdma-&gt;XferHalfCpltCallback != <span class="literal">NULL</span>)</div><div class="line">        &#123;</div><div class="line">          <span class="comment">/* Half transfer callback */</span></div><div class="line">          hdma-&gt;XferHalfCpltCallback(hdma);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* Transfer Complete Interrupt management ***********************************/</span></div><div class="line">  <span class="keyword">if</span> ((tmpisr &amp; (DMA_FLAG_TCIF0_4 &lt;&lt; hdma-&gt;StreamIndex)) != RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>(__HAL_DMA_GET_IT_SOURCE(hdma, DMA_IT_TC) != RESET)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Clear the transfer complete flag */</span></div><div class="line">      regs-&gt;IFCR = DMA_FLAG_TCIF0_4 &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line">      </div><div class="line">      <span class="keyword">if</span>(HAL_DMA_STATE_ABORT == hdma-&gt;State)</div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Disable all the transfer interrupts */</span></div><div class="line">        hdma-&gt;Instance-&gt;CR  &amp;= ~(DMA_IT_TC | DMA_IT_TE | DMA_IT_DME);</div><div class="line">        hdma-&gt;Instance-&gt;FCR &amp;= ~(DMA_IT_FE);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>((hdma-&gt;XferHalfCpltCallback != <span class="literal">NULL</span>) || (hdma-&gt;XferM1HalfCpltCallback != <span class="literal">NULL</span>))</div><div class="line">        &#123;</div><div class="line">          hdma-&gt;Instance-&gt;CR  &amp;= ~(DMA_IT_HT);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* Clear all interrupt flags at correct offset within the register */</span></div><div class="line">        regs-&gt;IFCR = <span class="number">0x3F</span>U &lt;&lt; hdma-&gt;StreamIndex;</div><div class="line"></div><div class="line">        <span class="comment">/* Process Unlocked */</span></div><div class="line">        __HAL_UNLOCK(hdma);</div><div class="line"></div><div class="line">        <span class="comment">/* Change the DMA state */</span></div><div class="line">        hdma-&gt;State = HAL_DMA_STATE_READY;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(hdma-&gt;XferAbortCallback != <span class="literal">NULL</span>)</div><div class="line">        &#123;</div><div class="line">          hdma-&gt;XferAbortCallback(hdma);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span>(((hdma-&gt;Instance-&gt;CR) &amp; (<span class="keyword">uint32_t</span>)(DMA_SxCR_DBM)) != RESET)</div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Current memory buffer used is Memory 0 */</span></div><div class="line">        <span class="keyword">if</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_CT) == RESET)</div><div class="line">        &#123;</div><div class="line">          <span class="keyword">if</span>(hdma-&gt;XferM1CpltCallback != <span class="literal">NULL</span>)</div><div class="line">          &#123;</div><div class="line">            <span class="comment">/* Transfer complete Callback for memory1 */</span></div><div class="line">            hdma-&gt;XferM1CpltCallback(hdma);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/* Current memory buffer used is Memory 1 */</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">          <span class="keyword">if</span>(hdma-&gt;XferCpltCallback != <span class="literal">NULL</span>)</div><div class="line">          &#123;</div><div class="line">            <span class="comment">/* Transfer complete Callback for memory0 */</span></div><div class="line">            hdma-&gt;XferCpltCallback(hdma);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/* Disable the transfer complete interrupt if the DMA mode is not CIRCULAR */</span></div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        <span class="keyword">if</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_CIRC) == RESET)</div><div class="line">        &#123;</div><div class="line">          <span class="comment">/* Disable the transfer complete interrupt */</span></div><div class="line">          hdma-&gt;Instance-&gt;CR  &amp;= ~(DMA_IT_TC);</div><div class="line"></div><div class="line">          <span class="comment">/* Process Unlocked */</span></div><div class="line">          __HAL_UNLOCK(hdma);</div><div class="line"></div><div class="line">          <span class="comment">/* Change the DMA state */</span></div><div class="line">          hdma-&gt;State = HAL_DMA_STATE_READY;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(hdma-&gt;XferCpltCallback != <span class="literal">NULL</span>)</div><div class="line">        &#123;</div><div class="line">          <span class="comment">/* Transfer complete callback */</span></div><div class="line">          hdma-&gt;XferCpltCallback(hdma);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">/* manage error case */</span></div><div class="line">  <span class="keyword">if</span>(hdma-&gt;ErrorCode != HAL_DMA_ERROR_NONE)</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>((hdma-&gt;ErrorCode &amp; HAL_DMA_ERROR_TE) != RESET)</div><div class="line">    &#123;</div><div class="line">      hdma-&gt;State = HAL_DMA_STATE_ABORT;</div><div class="line"></div><div class="line">      <span class="comment">/* Disable the stream */</span></div><div class="line">      __HAL_DMA_DISABLE(hdma);</div><div class="line"></div><div class="line">      <span class="keyword">do</span></div><div class="line">      &#123;</div><div class="line">        <span class="keyword">if</span> (++count &gt; timeout)</div><div class="line">        &#123;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">while</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_EN) != RESET);</div><div class="line"></div><div class="line">      <span class="comment">/* Process Unlocked */</span></div><div class="line">      __HAL_UNLOCK(hdma);</div><div class="line"></div><div class="line">      <span class="comment">/* Change the DMA state */</span></div><div class="line">      hdma-&gt;State = HAL_DMA_STATE_READY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(hdma-&gt;XferErrorCallback != <span class="literal">NULL</span>)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* Transfer error callback */</span></div><div class="line">      hdma-&gt;XferErrorCallback(hdma);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;该函数中主要关注半传输完成中断以及传输完成中断。</p>
<p>&emsp;对于半传输完成中断相关函数，其主要功能有：</p>
<ul>
<li>清除半传输完成中断标志位；</li>
<li><code>DMA_SxCR</code>寄存器DBM位为复位状态，双缓冲器模式未使能；</li>
<li><code>DMA_SxCR</code>寄存器CIRC位为复位状态，循环模式为禁止状态；禁用DMA半传输中断；</li>
<li>本例中半传输完成中断回调函数为空函数，不执行任何操作。</li>
</ul>
<p>&emsp;对于传输完成中断相关函数，其主要功能有：</p>
<ul>
<li>清除传输完成中断标志位；</li>
<li>如果DMA状态为ABORT，禁用所有DMA中断，清除所有中断标志位，并调用ABORT回调函数；</li>
<li><code>DMA_SxCR</code>寄存器DBM位为复位状态，双缓冲器模式未使能；</li>
<li><code>DMA_SxCR</code>寄存器CIRC位为复位状态，循环模式为禁止状态；</li>
<li>调用传输完成中断回调函数<code>UART_DMATransmitCplt()</code>，该函数具体如下。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief DMA UART transmit process complete callback</div><div class="line">  * @param hdma DMA handle</div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UART_DMATransmitCplt</span><span class="params">(DMA_HandleTypeDef *hdma)</span></span></div><div class="line">&#123;</div><div class="line">  UART_HandleTypeDef* huart = ( UART_HandleTypeDef* )((DMA_HandleTypeDef* )hdma)-&gt;Parent;</div><div class="line"></div><div class="line">  <span class="comment">/* DMA Normal mode*/</span></div><div class="line">  <span class="keyword">if</span>((hdma-&gt;Instance-&gt;CR &amp; DMA_SxCR_CIRC) == <span class="number">0U</span>)</div><div class="line">  &#123;</div><div class="line">    huart-&gt;TxXferCount = <span class="number">0U</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Disable the DMA transfer for transmit request by setting the DMAT bit</span></div><div class="line">       in the UART CR3 register */</div><div class="line">    CLEAR_BIT(huart-&gt;Instance-&gt;CR3, USART_CR3_DMAT);</div><div class="line"></div><div class="line">    <span class="comment">/* Enable the UART Transmit Complete Interrupt */</span></div><div class="line">    SET_BIT(huart-&gt;Instance-&gt;CR1, USART_CR1_TCIE);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">/* DMA Circular mode */</span></div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    HAL_UART_TxCpltCallback(huart);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;<code>UART_DMATransmitCplt()</code>的功能如下：</p>
<ul>
<li>本例中DMA模式为Normal；</li>
<li>DMA发送计数器置零；</li>
<li>禁止DMA发送模式；</li>
<li>通过置位<code>USARTx_CR1</code>寄存器TCIE位，软件产生一个UART传输完成中断。</li>
</ul>
<h3 id="UART中断服务函数"><a href="#UART中断服务函数" class="headerlink" title="UART中断服务函数"></a>UART中断服务函数</h3><p>&emsp;UART中断服务函数如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* @brief This function handles USART1 global interrupt.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">USART1_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* USER CODE BEGIN USART1_IRQn 0 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END USART1_IRQn 0 */</span></div><div class="line">  HAL_UART_IRQHandler(&amp;huart1);</div><div class="line">  <span class="comment">/* USER CODE BEGIN USART1_IRQn 1 */</span></div><div class="line"></div><div class="line">  <span class="comment">/* USER CODE END USART1_IRQn 1 */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief This function handles UART interrupt request.</div><div class="line">  * @param huart uart handle</div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_UART_IRQHandler</span><span class="params">(UART_HandleTypeDef *huart)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">uint32_t</span> isrflags   = READ_REG(huart-&gt;Instance-&gt;ISR);</div><div class="line">  <span class="keyword">uint32_t</span> cr1its     = READ_REG(huart-&gt;Instance-&gt;CR1);</div><div class="line">  <span class="keyword">uint32_t</span> cr3its     = READ_REG(huart-&gt;Instance-&gt;CR3);</div><div class="line">  <span class="keyword">uint32_t</span> errorflags;</div><div class="line"></div><div class="line">  <span class="comment">/* If no error occurs */</span></div><div class="line">  errorflags = (isrflags &amp; (<span class="keyword">uint32_t</span>)(USART_ISR_PE | USART_ISR_FE | USART_ISR_ORE | USART_ISR_NE));</div><div class="line">  <span class="keyword">if</span> (errorflags == RESET)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">/* UART in mode Receiver ---------------------------------------------------*/</span></div><div class="line">    <span class="keyword">if</span>(((isrflags &amp; USART_ISR_RXNE) != RESET) &amp;&amp; ((cr1its &amp; USART_CR1_RXNEIE) != RESET))</div><div class="line">    &#123;</div><div class="line">      UART_Receive_IT(huart);</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* If some errors occur */</span></div><div class="line">  <span class="keyword">if</span>(   (errorflags != RESET)</div><div class="line">     &amp;&amp; (   ((cr3its &amp; USART_CR3_EIE) != RESET)</div><div class="line">         || ((cr1its &amp; (USART_CR1_RXNEIE | USART_CR1_PEIE)) != RESET)) )</div><div class="line">  &#123;</div><div class="line"></div><div class="line">    <span class="comment">/* UART parity error interrupt occurred -------------------------------------*/</span></div><div class="line">    <span class="keyword">if</span>(((isrflags &amp; USART_ISR_PE) != RESET) &amp;&amp; ((cr1its &amp; USART_CR1_PEIE) != RESET))</div><div class="line">    &#123;</div><div class="line">      __HAL_UART_CLEAR_IT(huart, UART_CLEAR_PEF);</div><div class="line"></div><div class="line">      huart-&gt;ErrorCode |= HAL_UART_ERROR_PE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* UART frame error interrupt occurred --------------------------------------*/</span></div><div class="line">    <span class="keyword">if</span>(((isrflags &amp; USART_ISR_FE) != RESET) &amp;&amp; ((cr3its &amp; USART_CR3_EIE) != RESET))</div><div class="line">    &#123;</div><div class="line">      __HAL_UART_CLEAR_IT(huart, UART_CLEAR_FEF);</div><div class="line"></div><div class="line">      huart-&gt;ErrorCode |= HAL_UART_ERROR_FE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* UART noise error interrupt occurred --------------------------------------*/</span></div><div class="line">    <span class="keyword">if</span>(((isrflags &amp; USART_ISR_NE) != RESET) &amp;&amp; ((cr3its &amp; USART_CR3_EIE) != RESET))</div><div class="line">    &#123;</div><div class="line">      __HAL_UART_CLEAR_IT(huart, UART_CLEAR_NEF);</div><div class="line"></div><div class="line">      huart-&gt;ErrorCode |= HAL_UART_ERROR_NE;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/* UART Over-Run interrupt occurred -----------------------------------------*/</span></div><div class="line">    <span class="keyword">if</span>(((isrflags &amp; USART_ISR_ORE) != RESET) &amp;&amp;</div><div class="line">       (((cr1its &amp; USART_CR1_RXNEIE) != RESET) || ((cr3its &amp; USART_CR3_EIE) != RESET)))</div><div class="line">    &#123;</div><div class="line">      __HAL_UART_CLEAR_IT(huart, UART_CLEAR_OREF);</div><div class="line"></div><div class="line">      huart-&gt;ErrorCode |= HAL_UART_ERROR_ORE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* Call UART Error Call back function if need be --------------------------*/</span></div><div class="line">    <span class="keyword">if</span>(huart-&gt;ErrorCode != HAL_UART_ERROR_NONE)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">/* UART in mode Receiver ---------------------------------------------------*/</span></div><div class="line">      <span class="keyword">if</span>(((isrflags &amp; USART_ISR_RXNE) != RESET) &amp;&amp; ((cr1its &amp; USART_CR1_RXNEIE) != RESET))</div><div class="line">      &#123;</div><div class="line">        UART_Receive_IT(huart);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/* If Overrun error occurs, or if any error occurs in DMA mode reception,</span></div><div class="line">         consider error as blocking */</div><div class="line">      <span class="keyword">if</span> (((huart-&gt;ErrorCode &amp; HAL_UART_ERROR_ORE) != RESET) ||</div><div class="line">          (HAL_IS_BIT_SET(huart-&gt;Instance-&gt;CR3, USART_CR3_DMAR)))</div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Blocking error : transfer is aborted</span></div><div class="line">           Set the UART state ready to be able to start again the process,</div><div class="line">           Disable Rx Interrupts, and disable Rx DMA request, if ongoing */</div><div class="line">        UART_EndRxTransfer(huart);</div><div class="line"></div><div class="line">        <span class="comment">/* Disable the UART DMA Rx request if enabled */</span></div><div class="line">        <span class="keyword">if</span> (HAL_IS_BIT_SET(huart-&gt;Instance-&gt;CR3, USART_CR3_DMAR))</div><div class="line">        &#123;</div><div class="line">          CLEAR_BIT(huart-&gt;Instance-&gt;CR3, USART_CR3_DMAR);</div><div class="line"></div><div class="line">          <span class="comment">/* Abort the UART DMA Rx channel */</span></div><div class="line">          <span class="keyword">if</span>(huart-&gt;hdmarx != <span class="literal">NULL</span>)</div><div class="line">          &#123;</div><div class="line">            <span class="comment">/* Set the UART DMA Abort callback :</span></div><div class="line">            will lead to call HAL_UART_ErrorCallback() at end of DMA abort procedure */</div><div class="line">            huart-&gt;hdmarx-&gt;XferAbortCallback = UART_DMAAbortOnError;</div><div class="line"></div><div class="line">            <span class="comment">/* Abort DMA RX */</span></div><div class="line">            <span class="keyword">if</span>(HAL_DMA_Abort_IT(huart-&gt;hdmarx) != HAL_OK)</div><div class="line">            &#123;</div><div class="line">              <span class="comment">/* Call Directly huart-&gt;hdmarx-&gt;XferAbortCallback function in case of error */</span></div><div class="line">              huart-&gt;hdmarx-&gt;XferAbortCallback(huart-&gt;hdmarx);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">else</span></div><div class="line">          &#123;</div><div class="line">            <span class="comment">/* Call user error callback */</span></div><div class="line">            HAL_UART_ErrorCallback(huart);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">          <span class="comment">/* Call user error callback */</span></div><div class="line">          HAL_UART_ErrorCallback(huart);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        <span class="comment">/* Non Blocking error : transfer could go on.</span></div><div class="line">           Error is notified to user through user error callback */</div><div class="line">        HAL_UART_ErrorCallback(huart);</div><div class="line">        huart-&gt;ErrorCode = HAL_UART_ERROR_NONE;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line"></div><div class="line">  &#125; <span class="comment">/* End if some error occurs */</span></div><div class="line"></div><div class="line">  <span class="comment">/* UART in mode Transmitter ------------------------------------------------*/</span></div><div class="line">  <span class="keyword">if</span>(((isrflags &amp; USART_ISR_TXE) != RESET) &amp;&amp; ((cr1its &amp; USART_CR1_TXEIE) != RESET))</div><div class="line">  &#123;</div><div class="line">    UART_Transmit_IT(huart);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/* UART in mode Transmitter (transmission end) -----------------------------*/</span></div><div class="line">  <span class="keyword">if</span>(((isrflags &amp; USART_ISR_TC) != RESET) &amp;&amp; ((cr1its &amp; USART_CR1_TCIE) != RESET))</div><div class="line">  &#123;</div><div class="line">    UART_EndTransmit_IT(huart);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief  Wrap up transmission in non-blocking mode.</div><div class="line">  * @param  huart pointer to a UART_HandleTypeDef structure that contains</div><div class="line">  *                the configuration information for the specified UART module.</div><div class="line">  * @retval HAL status</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">static</span> HAL_StatusTypeDef <span class="title">UART_EndTransmit_IT</span><span class="params">(UART_HandleTypeDef *huart)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">/* Disable the UART Transmit Complete Interrupt */</span></div><div class="line">  CLEAR_BIT(huart-&gt;Instance-&gt;CR1, USART_CR1_TCIE);</div><div class="line"></div><div class="line">  <span class="comment">/* Tx process is ended, restore huart-&gt;gState to Ready */</span></div><div class="line">  huart-&gt;gState = HAL_UART_STATE_READY;</div><div class="line"></div><div class="line">  HAL_UART_TxCpltCallback(huart);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> HAL_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">  * @brief Tx Transfer completed callbacks</div><div class="line">  * @param huart uart handle</div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line"></div><div class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> uartReady;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_UART_TxCpltCallback</span><span class="params">(UART_HandleTypeDef *huart)</span></span></div><div class="line">&#123;</div><div class="line">	uartReady = <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;这里主要关注中断传输完成中断：</p>
<ul>
<li>TC软件置位产生的中断传输完成中断中调用<code>UART_EndTransmit_IT()</code>函数；</li>
<li><code>UART_EndTransmit_IT()</code>函数复位<code>USARTx_CR1</code>寄存器TCIE位，禁止传输完成中断；继而调用<code>HAL_UART_TxCpltCallback()</code>函数；</li>
<li><code>HAL_UART_TxCpltCallback()</code>函数为自定义函数。</li>
</ul>
<h2 id="实验验证"><a href="#实验验证" class="headerlink" title="实验验证"></a>实验验证</h2><p>&emsp;验证程序设置如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">uint8 sendStr[<span class="number">65535</span>] = <span class="string">"1234567890"</span>;</div><div class="line">uint8 uartReady = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">&#123;</div><div class="line">	mainloop++;</div><div class="line">	  </div><div class="line">	oled_putuint32(<span class="number">0</span>, <span class="number">2</span>, mainloop);  </div><div class="line">	oled_putuint32(<span class="number">0</span>, <span class="number">3</span>, __HAL_DMA_GET_COUNTER(&amp;hdma_usart1_tx));</div><div class="line">	    </div><div class="line">	<span class="keyword">if</span> (uartReady == TRUE)</div><div class="line">	 &#123;</div><div class="line">		uartReady = FALSE;</div><div class="line">		test = HAL_UART_Transmit_DMA(&amp;huart1,sendStr,<span class="keyword">sizeof</span>(sendStr));</div><div class="line">	&#125;  	  	  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;其基本原理为调用<code>HAL_UART_Transmit_DMA()</code>函数进行发送，同时通过<code>__HAL_DMA_GET_COUNTER()</code>获取DMA数据流传输中的剩余数据数目并实时显示。当DMA发送完成并通过TC为触发UART中断后，将<code>uartReady</code>置位，此时可以进行新一轮DMA传输。</p>
<p>&emsp;实验结果为：OLED显示器实时显示DMA数据流传输的剩余数据数目；串口接收软件可以接收到发送的数据(但是由于数据流速率过高，串口软件有时无法正常显示)。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2018/05/19/stm32f767-uart-dma/">STM32F767 DMA的基本用法</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">焦迪</a></p>
        <p><span>发布时间:</span>2018-05-19, 20:19:51</p>
        <p><span>最后更新:</span>2018-05-21, 23:01:43</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2018/05/19/stm32f767-uart-dma/" title="STM32F767 DMA的基本用法">http://jiaodi.tech/2018/05/19/stm32f767-uart-dma/</a>
            <span class="copy-path" data-clipboard-text="原文: http://jiaodi.tech/2018/05/19/stm32f767-uart-dma/　　作者: 焦迪" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/05/21/stm32f767-rtc/">
                    STM32F767 RTC的基本用法
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2018/05/07/stm32f767-pwm/">
                    STM32F767 PWM的基本用法
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#开发环境"><span class="toc-number">1.</span> <span class="toc-text">开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#硬件环境"><span class="toc-number">1.1.</span> <span class="toc-text">硬件环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#软件环境"><span class="toc-number">1.2.</span> <span class="toc-text">软件环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DMA的基本特性"><span class="toc-number">2.</span> <span class="toc-text">DMA的基本特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统框图"><span class="toc-number">2.1.</span> <span class="toc-text">系统框图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主要特性"><span class="toc-number">2.2.</span> <span class="toc-text">主要特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DMA通道选择"><span class="toc-number">2.3.</span> <span class="toc-text">DMA通道选择</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DMA的基本设置"><span class="toc-number">3.</span> <span class="toc-text">DMA的基本设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DMA通道选择-1"><span class="toc-number">3.1.</span> <span class="toc-text">DMA通道选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DMA时钟与NVIC初始化"><span class="toc-number">3.2.</span> <span class="toc-text">DMA时钟与NVIC初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UART初始化"><span class="toc-number">3.3.</span> <span class="toc-text">UART初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HAL-DMA-Init-实现"><span class="toc-number">3.4.</span> <span class="toc-text">HAL_DMA_Init()实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HAL-LINKDMA-实现"><span class="toc-number">3.5.</span> <span class="toc-text">__HAL_LINKDMA()实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于DMA的UART发送实现"><span class="toc-number">4.</span> <span class="toc-text">基于DMA的UART发送实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HAL-UART-Transmit-DMA-实现"><span class="toc-number">4.1.</span> <span class="toc-text">HAL_UART_Transmit_DMA()实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HAL-DMA-Start-IT-实现"><span class="toc-number">4.2.</span> <span class="toc-text">HAL_DMA_Start_IT()实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DMA中断服务函数"><span class="toc-number">4.3.</span> <span class="toc-text">DMA中断服务函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UART中断服务函数"><span class="toc-number">4.4.</span> <span class="toc-text">UART中断服务函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实验验证"><span class="toc-number">5.</span> <span class="toc-text">实验验证</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>





    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="2018/05/19/stm32f767-uart-dma/" data-title="STM32F767 DMA的基本用法" data-url="http://jiaodi.tech/2018/05/19/stm32f767-uart-dma/"></div>
    <script>
        var duoshuoQuery = {short_name:"null"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/05/21/stm32f767-rtc/" title="上一篇: STM32F767 RTC的基本用法">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2018/05/07/stm32f767-pwm/" title="下一篇: STM32F767 PWM的基本用法">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/11/stm32f767-fmc-ad7616/">利用SMT32F767驱动AD7616</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/stm32f767-mpu/">STM32F767 MPU的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/16/stm32f767-sdram/">STM32F767 FMC-SDRAM的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/stm32f767-qspi/">STM32F767 QUADSPI的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/27/stm32f767-flash/">STM32F767 Flash的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/21/stm32f767-rtc/">STM32F767 RTC的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/19/stm32f767-uart-dma/">STM32F767 DMA的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/07/stm32f767-pwm/">STM32F767 PWM的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/28/feedforward-cap/">优化前馈电容改善DCDC的瞬态响应(未完成)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/25/stm32f767-wwdg/">STM32F767 WWDG的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/21/stm32f767-iwdg/">STM32F767 IWDG的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/stm32f767-timer/">STM32F767 Timer中断的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/08/stm32f767-gpio-it/">STM32F767 GPIO中断的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/05/stm32f767-GPIO-UART/">STM32F767 GPIO与UART的基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/29/stm32f767-delay/">STM32F767 delay函数的HAL库实现与优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/stm32f767-system/">STM32F767系统内核与时钟设置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/18/stm32f767newpro/">新建一个STM32F767工程(基于HAL库)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/17/stm32f767-start/">使用STM32CubeMX新建STM32F7工程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/12/mlcc-noise/">电源应用中MLCC啸叫问题的分析与解决</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/04/pierce-oscillator/">Pierce振荡器的原理与设计方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/28/F28379D-new-pro-cpu1/">F28379D新建工程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/23/python-pyinstaller/">PyInstaller基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/14/HDC1010-C2000/">使用F28069驱动温湿度传感器HDC1010</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/14/IEEEStd802-11/">IEEE Std 802.11a/g/n/ac</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/08/XDS100-VCP/">加载C2000 XDS100仿真器的虚拟串口(VCP)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/06/MarkdownSyntax/">Markdown基本语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/21/BuckPowerStage/">Buck电路的功率部分设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/myserial/">使用C#构建一个串口程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/allegro-guide-2/">Allegro学习笔记-差分线与等长线</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/allegro-guide-1/">Allegro学习笔记-基础篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/04/cadence-allegro-package/">使用Ultra Librarian创建Cadence原理图与PCB封装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/06/新建一个C2000工程/">新建一个C2000工程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/06/安装CCS与controlSUITE/">安装CCS与controlSUITE</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2018 焦迪
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>